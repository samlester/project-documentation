<!-- @include _header -->
<!-- $title Chapter 5: Implementation -->

<div class="row">
	<div class="w12">
		<div class="section">
			<h1><!-- $title --></h1>
			<p>In this chapter I will run through the process I took to create the application.</p>
		</div>

		<div class="section" id="technologies">
			<h2>5.1 Technologies</h2>
			<p>Before starting to implement my application I went through the process of learning about various technologies that I could use to create the application including language, hosting, versioning and frameworks.</p>

			<h3>Languages</h3>
			<p>Theoretically the application could be written in many different languages. The usual choice for a project like this would be PHP due to it's high levels of adoption amongst the web community that means it's very easy to find solutions to potential problems. It was originally created by taking bits of syntax from three other languages (C, Java, and Perl) <span class="cite"></span> when I've previously used the language I've found it to be quite disorganised and on occasion, not very logical to use and understand.</p>
			<p>Increasingly web apps are also created using JavaScript with the help of platforms like Node.js that can run scripts server-side, reducing the requirements of the user's computer. This was a tempting option as I already have a good understanding of Javascipt through my previous role as a front-end web developer.</p>
			<p>In the end I decided to build the application using Ruby, one of a newer breed of languages have emerged to allow for the quicker and more efficient development of web applications. Languages like Ruby and Python are built to be extremely fast and lightweight without all of the historical idiosyncrasies that come with older languages. <span class="cite"></span></p>

			<h3>Application frameworks</h3>
			<p><span class="revise">An application framework is a preset structure which allows for the quicker development of an application. They generally contain all of the basic functions that a web application requires, saving the time of creating them for each new application. <span class="cite"></span> They also follow certain conventions so that developers can collaborate easily without having to learn a custom-built structure each time.</span></p>
			<p>Having decided that Ruby is the best language choice for this project I started looking at the available application frameworks I could use during development. Two main ones appeared</p>

			<h3>Front-end frameworks</h3>
			<p>Twitter Bootstrap is an open source front-end development framework that allows for the creation of the basic structure of  websites and web applications to be accomplished extremely quickly. It provides a large library of standard UI paradigms along with basic CSS and JavaScript to support them.</p>

			<h3>Versioning</h3>
			<p>In a project as dynamic as this one it's important to keep track of bugs that occur as well as being able to roll back to previous versions of the software. There are a variety of software packages available to facilitate this.</p>
			<p>Git is a versioning and Source Code Management (SCM) package which allows developers of applications to keep several revisions of their code.</p>
			<p>Github is a web application (incidentally built on Ruby) which allows the publishing and sharing of Git repositories.</p>
		</div>

		<div class="section">
			<h2>5.2 Using Ruby on Rails</h2>
			<p>Having decided that Ruby on Rails was the system that Scoop would be based upon I began researching and familiarising myself with the way that it works. This included following online tutorials from <a href="http://teamtreehouse.com/library/programming/build-a-simple-ruby-on-rails-application">Treehouse</a> and attending a <a href="https://generalassemb.ly/">General Assembly</a> workshop on getting started with Ruby</p>
			<p><span class="more"></span></p>

			<h3>Model–view–controller (MVC)</h3>
			<p>Model–view–controller (more commonly known as MVC) is a software architecture pattern which aims to separate the presentation of content to the user with the back-end logic that processes data <span class="cite"></span>. Each part of MVC has it's own role to play in responding to a user's requests:</p>
			<ul>
				<li>Models contain the structure of the data within the application and the majority of the logic used to process data.</li>
				<li>Views function only to present data to the user. They normally represent the interface of the application although the could be responsible for returning other formats.</li>
				<li>Controllers bring the Models and Views together by fetching data from the Models and responding to user requests in the form of a View.</li>
			</ul>
			<p>Rails is entirely based around MVC <span class="more"></span>. One of the advantages of using Rails is that it can generate models, controllers and views from the command line. Together these components are called a scaffold and provide an extremely basic framework for passing data between the elements of MVC.</p>
			
			<h3>Gems</h3>
			<p>Ruby uses a system of plugins called gems which allow developers to add additional functionality to their apps using <span class="cite"></span>. Rails is itself a gem as is the sqlite</p>
			<p>Upon install Rails includes some gems by default including <code>sqlite3</code>, <code>jquery-rails</code> and a few others that manage asset functionality. The names of all the gems that a project can be found in the Gemfile. Upon running the <code>bundle install</code> command each gem is downloaded and installed.</p>
			<p>In addition to the default set Scoop uses a variety of other gems which make certain tasks simpler.</p>
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Purpose</th>
						<th>Repository</th>
						<th>License</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>simple_form</td>
						<td>Creates and formats user input forms for Twitter Bootstrap</td>
						<td>https://github.com/plataformatec/simple_form</td>
						<td>MIT</td>
					</tr>
					<tr>
						<td>devise</td>
						<td>Deals with user authentication (sign up/sign in, protected controllers)</td>
						<td>https://github.com/plataformatec/devise</td>
						<td>MIT</td>
					</tr>
					<tr>
						<td>nokogiri</td>
						<td>Used to help parse HTML documents retrieved during the crawl process</td>
						<td>https://github.com/sparklemotion/nokogiri</td>
						<td>MIT</td>
					</tr>
					<tr>
						<td>robotex</td>
						<td>Used to make anemone obey robots.txt when crawling sites</td>
						<td>https://github.com/chriskite/robotex</td>
						<td>Custom (Open source)</td>
					</tr>
					<tr>
						<td>anemone</td>
						<td>Used to </td>
						<td>https://github.com/chriskite/anemone</td>
						<td>Custom (Open source)</td>
					</tr>
					<tr>
						<td>garb</td>
						<td>Ruby wrapper for the Google Analytics API</td>
						<td>https://github.com/Sija/garb</td>
						<td>MIT</td>
					</tr>
					<tr>
						<td>paperclip</td>
						<td>Manages file upload and storage</td>
						<td>https://github.com/thoughtbot/paperclip</td>
						<td>MIT</td>
					</tr>
					<tr>
						<td>certified</td>
						<td>Solves a problem with SSL certification</td>
						<td>https://github.com/stevegraham/certified</td>
						<td>-</td>
					</tr>
					<tr>
						<td>omniauth</td>
						<td></td>
						<td>https://github.com/intridea/omniauth</td>
						<td>Custom (Open source)</td>
					</tr>
					<tr>
						<td>omniauth-google-oauth2</td>
						<td></td>
						<td>https://github.com/zquestz/omniauth-google-oauth2</td>
						<td>Custom (Open source)</td>
					</tr>
					<tr>
						<td>delayed_job_active_record</td>
						<td></td>
						<td>https://github.com/collectiveidea/delayed_job_active_record</td>
						<td></td>
					</tr>
					<tr>
						<td>daemons</td>
						<td></td>
						<td>https://github.com/ghazel/daemons</td>
						<td>Custom (Open source)</td>
					</tr>
					<tr>
						<td>google_visualr</td>
						<td></td>
						<td>https://github.com/winston/google_visualr</td>
						<td>MIT</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="section">
			<h2>5.X Using Git</h2>
			<p>Version control is </p>
			<p> <code>git status</code></p>
		</div>

		<div class="section">
			<h2>5.X Creating and updating the database</h2>
			<p>Rather than creating a database structure and then implementing it using a Database Management System (DBMS) as is standard when creating a system using PHP and MySQL Rails uses models to store information about the name, content and validation of various fields. The information from the models can then be implemented into any database system using a migration. Scoop uses the standard Rails system, SQLite.</p>
			<p>Prior to creating the database</p>
			<p>Changes to the database were made using individual migrations like the one below:</p>
			<pre><code data-language="ruby" data-line="1">class AddCrawlStatusToSites < ActiveRecord::Migration
  def change
    add_column :sites, :crawling, :boolean
  end
end</code></pre>
			<p>This simple migration adds a new column (crawling) to the sites table with the boolean type. The changes outlined in the migration can then be made to the database using this command:</p>
			<pre><code data-language="shell" data-line="1">$ rake db:migrate</code></pre>
			<p>At any time the complete database structure can be found in the <code>db/schema.rb</code> file:</p>
			<pre><code data-language="ruby" data-line="1">ActiveRecord::Schema.define(:version => 20130409221522) do

	create_table "sites", :force => true do |t|
	    t.string   "name"
	    t.string   "url"
	    t.datetime "created_at",        :null => false
	    t.datetime "updated_at",        :null => false
	    t.integer  "user_id"
	    t.string   "icon_file_name"
	    t.string   "icon_content_type"
	    t.integer  "icon_file_size"
	    t.datetime "icon_updated_at"
	    t.string   "icon_remote_url"
	    t.boolean  "crawling"
	end

	...

end</code></pre>
			<p>This extensive file describes all of the tables in the database similar to an SQL create file.</p>


		</div>

		<div class="section">
			<h2>5.X Crawl functionality</h2>
			<p>The ability of the application to crawl a website is key to it's overall purpose and so it was one of the first pieces of functionality to be created.</p>
			<figure>
				<img src="http://i.ten4design.co.uk/1000x200&text=Crawl process">
				<figcaption>Crawl process</figcaption>
			</figure>
			<p>Scoop's crawl functionality utilises four gems: <code>anemone</code>, <code>robotex</code>, <code>nokogiri</code> and <code>delayed_job</code></p>
			<p>The crawl process begins at the point where the user enters the site name and url. When the form is submitted it calls the create method in the site controller:</p>
			<pre><code data-language="ruby" data-line="1">def create
  @site = Site.new(params[:site])

  @site.user_id = current_user.id
  @site.crawling = 1

  doc = Nokogiri::HTML(open(@site.url))
  if !doc.css('link[rel=apple-touch-icon], link[rel=apple-touch-icon-precomposed]').blank?()
    @site.icon_remote_url = doc.css('link[rel=apple-touch-icon], link[rel=apple-touch-icon-precomposed]')[0]["href"]
  else
    @site.icon_remote_url = nil
  end 

  respond_to do |format|
    if @site.save
      @site.crawl
      format.html { redirect_to @site, notice: 'Site was successfully created.' }
      format.json { render json: @site, status: :created, location: @site }
    else
      format.html { render action: "new" }
      format.json { render json: @site.errors, status: :unprocessable_entity }
    end
  end
end</code></pre>
			<ol>
				<li>The POST data from the form is retrieved an placed inside the <code>@site</code> object.</li>
				<li>The current user's id and crawl status are added to the object.</li>
				<li>The site's homepage HTML is retrieved using <code>open</code> and prepared for <code>nokogiri</code>.</li>
				<li>A conditional statement checks if the page has an Apple touch icon. If so, it is retrieved and attached to the site object. If not, <code>nil</code> is entered instead.</li>
				<li><code>@site</code> is saved if the method was executed successfully.</li>
				<li><code>@site</code> is passed to the crawl method.</li>
				<li>The site view is returned with a notification message.</li>
			</ol>
			<p>At this point the user sees the site page with a progress indicator. The site is now in a queue to be processed using Delayed Job. The version of delayed job used in Scoop puts the queued items into a database table where they can be accessed by other methods without action from the user.</p>
			<p>The crawl method exists within the site model and is carried out as a background task:</p>

			<pre><code data-language="ruby" data-line="1">def crawl
  Anemone.crawl(url) do |anemone|
    anemone.on_every_page do |page|
      begin
        doc = Nokogiri::HTML(open(page.url))
        title = doc.css('title').inner_text
        url = page.url.path
        Page.create(:title=>title,:url=>url,:site_id=>id)
      rescue OpenURI::HTTPError => ex

      end 
    end
  end

  @site = Site.find(id)
  @site.crawling = false
  @site.save!
end
handle_asynchronously :crawl</code></pre>
			<ol>
				<li><code>Anemone</code> is called and passed the url of the site to be crawled.</li>
				<li>Each page on the site is retrieved using <code>open</code> and prepared for <code>nokogiri</code>.</li>
				<li>The <code>title</code> element is retrieved and saved as a variable.</li>
				<li>The path of each page is retrieved and saved as a variable.</li>
				<li>The retrieved information is saved to the pages table in the database.</li>
				<li>If HTTP errors are encountered (e.g. 404: Page not found, 401: Unauthorized) the page is skipped.</li>
			</ol>
			<p>This method </p>
		</div>

		<div class="section">
			<h2>5.X Connecting to Google Analytics</h2>
			<p>Originally the retrieval of Google Analytics data for each page was listed as a feature which</p>
		</div>
	
		<div class="section">
			<h2>5.X Google Charts</h2>
		</div>
		
		<a class="next-part" href="<!-- @path testing.html -->">Chapter 6: Testing</a>
	</div>
</div>

<!-- @include _footer -->